<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cotizador Pro | Metaverso ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .input-focus { transition: all 0.3s ease; border: 2px solid #e2e8f0; }
        .input-focus:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); outline: none; }
        /* Ocultar flechas de input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-64 bg-[#0f172a] text-white flex flex-col hidden lg:flex fixed h-full">
        <div class="p-8 border-b border-slate-800 flex items-center gap-3">
            <i class="fas fa-rocket text-blue-500 text-2xl"></i>
            <span class="font-black tracking-tighter text-xl">METAVERSO</span>
        </div>
        <nav class="p-6 space-y-2 flex-1">
            <a href="/dashboard" class="flex items-center gap-3 p-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-xl transition-all">
                <i class="fas fa-th-large"></i> Dashboard
            </a>
            <a href="/cotizaciones" class="flex items-center gap-3 p-3 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-900/50">
                <i class="fas fa-file-invoice-dollar"></i> Cotizaciones
            </a>
        </nav>
    </aside>

    <main class="flex-1 lg:ml-64 h-screen overflow-y-auto custom-scroll">
        <div class="p-8 max-w-6xl mx-auto">
            
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h1 class="text-3xl font-black text-slate-800 uppercase italic">Generador de Ofertas</h1>
                    <p class="text-slate-500 font-medium">Crea presupuestos profesionales en segundos</p>
                </div>
                <div class="text-right">
                    <span class="bg-blue-100 text-blue-700 px-4 py-1.5 rounded-full text-xs font-black uppercase tracking-widest border border-blue-200">Versión 4.1 Stable</span>
                </div>
            </div>

            <form action="/guardar-cotizacion" method="post" id="formCot" onsubmit="prepararEnvio(event)" class="space-y-6">
                
                <input type="hidden" name="items_json" id="items_json_field">
                <input type="hidden" name="empresa_tipo" id="empresa_tipo_field" value="A">
                <input type="hidden" name="cliente_info" id="hidden_nombre">
                <input type="hidden" name="nit" id="hidden_nit">
                <input type="hidden" name="email_destino" id="hidden_email">

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <div class="lg:col-span-2 space-y-6">
                        
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Cliente</label>
                                <select id="cliente_selector" onchange="seleccionarCliente(this)" class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl font-bold text-slate-700 input-focus" required>
                                    <option value="">-- Seleccionar Cliente --</option>
                                    {% for c in lista_clientes %}
                                        <option value="{{ c.nombre }}" data-nit="{{ c.nit }}" data-email="{{ c.email }}">{{ c.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Fecha de Emisión</label>
                                <input type="date" name="fecha" class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl font-bold text-slate-700 input-focus" required value="{{ hoy }}">
                            </div>
                            
                            <div class="md:col-span-2 mt-2">
                                <div class="flex items-center gap-2 text-xs text-slate-400">
                                    <i class="fas fa-id-card"></i>
                                    <span>NIT / CC detectado: </span>
                                    <span id="display_nit" class="font-bold text-slate-600">---</span>
                                    <span id="display_email" class="ml-4 font-bold text-blue-500"></span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b">
                                    <tr>
                                        <th class="p-5 w-1/2">Producto / Servicio</th>
                                        <th class="p-5 text-right w-1/6">Precio Unit.</th>
                                        <th class="p-5 text-center w-1/12">Cant.</th>
                                        <th class="p-5 text-right w-1/6">Subtotal</th>
                                        <th class="p-5 text-center w-1/12"></th>
                                    </tr>
                                </thead>
                                <tbody id="cuerpo_tabla" class="divide-y divide-slate-50">
                                    </tbody>
                            </table>
                            <div class="p-4 bg-slate-50/50">
                                <button type="button" onclick="agregarLinea()" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold hover:bg-white hover:text-blue-500 hover:border-blue-500 transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-plus-circle"></i> Agregar Ítem al Presupuesto
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 sticky top-4">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Configuración Fiscal</p>
                            <div class="flex gap-2 p-1 bg-slate-100 rounded-2xl mb-6">
                                <button type="button" onclick="setRegimen('A')" id="btnA" class="flex-1 py-3 rounded-xl text-xs font-black transition-all bg-white text-blue-600 shadow-sm">SAS (IVA)</button>
                                <button type="button" onclick="setRegimen('B')" id="btnB" class="flex-1 py-3 rounded-xl text-xs font-black transition-all text-slate-500">INDIVIDUAL</button>
                            </div>
                            
                            <div class="h-32 bg-slate-50 rounded-2xl border-2 border-dashed flex items-center justify-center p-4 mb-4 overflow-hidden">
                                <img id="logo_vista" src="/static/{{ empresa_a.logo_img }}" class="max-h-full object-contain">
                            </div>

                            <div class="space-y-3 pt-4 border-t border-slate-100">
                                <div class="flex justify-between text-slate-500 font-bold text-xs uppercase">
                                    <span>Subtotal</span>
                                    <span id="txt_subtotal">$ 0</span>
                                </div>
                                <div id="fila_iva" class="flex justify-between text-blue-600 font-bold text-xs uppercase">
                                    <span>IVA (19%)</span>
                                    <span id="txt_iva">$ 0</span>
                                </div>
                                <div class="flex justify-between items-center bg-slate-900 text-white p-5 rounded-2xl mt-4 shadow-lg shadow-slate-300">
                                    <span class="text-[10px] font-black uppercase opacity-70">Total A Pagar</span>
                                    <span id="txt_total" class="text-2xl font-black font-mono tracking-tighter">$ 0</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 text-center">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Firma Autorizada</p>
                            <img src="/static/Firma_Rep.png" class="h-16 mx-auto opacity-80 hover:opacity-100 transition-opacity" alt="Firma">
                            <p class="text-[10px] font-bold text-slate-800 mt-2 uppercase">Representante Legal</p>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-black py-5 rounded-3xl shadow-xl shadow-blue-200 transition-transform active:scale-95 flex items-center justify-center gap-3 text-lg">
                            <i class="fas fa-save"></i> GUARDAR COTIZACIÓN
                        </button>
                    </div>
                </div>
            </form>

            <div class="mt-12 bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden mb-12">
                <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                    <h3 class="font-black text-slate-800 uppercase text-sm tracking-widest">Historial Reciente</h3>
                    <i class="fas fa-history text-slate-300"></i>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <tbody class="divide-y divide-slate-50">
                            {% for c in cotizaciones %}
                            <tr class="hover:bg-slate-50/50 transition-colors group">
                                <td class="p-5">
                                    <p class="text-xs font-black text-slate-700 uppercase">{{ c.cliente }}</p>
                                    <p class="text-[10px] text-slate-400 font-bold group-hover:text-blue-500 transition-colors">{{ c.fecha }}</p>
                                </td>
                                <td class="p-5 text-right">
                                    <span class="font-mono font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">$ {{ "{:,.0f}".format(c.total) }}</span>
                                </td>
                                
                                <td class="p-5 text-right flex justify-end gap-2">
                                <a href="/imprimir-cotizacion/{{ c.id }}" class="bg-white border border-slate-200 hover:bg-slate-800 hover:text-white hover:border-slate-800 text-slate-500 px-3 py-2 rounded-xl text-[10px] font-black transition-all inline-flex items-center gap-2" title="Ver o Imprimir">
                                <i class="fas fa-eye"></i> VER
                                </a>

                                <a href="/eliminar-cotizacion/{{ c.id }}" 
                                onclick="return confirm('⚠️ ¿Estás seguro de ELIMINAR la Cotización #{{ c.id }}? Esta acción es irreversible.')" 
                                class="bg-red-50 border border-red-100 hover:bg-red-600 hover:text-white text-red-500 px-3 py-2 rounded-xl text-[10px] font-black transition-all inline-flex items-center gap-2" title="Eliminar Cotización">
                                <i class="fas fa-trash-alt"></i>
                               </a>
                               </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Cargamos el catálogo de forma segura. Si falla, array vacío.
        const catalogo = {{ productos_json | safe }} || [];
        
        // Formateador de moneda colombiana
        const formatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
        
        let regimen = 'A';
        let itemCount = 0;

        // 1. FUNCIÓN PARA MANEJAR DATOS DEL CLIENTE
        function seleccionarCliente(select) {
            const opcion = select.options[select.selectedIndex];
            
            // Llenar campos visibles
            const nit = opcion.getAttribute('data-nit') || '';
            const email = opcion.getAttribute('data-email') || '';
            
            document.getElementById('display_nit').textContent = nit ? nit : '---';
            document.getElementById('display_email').textContent = email ? '(' + email + ')' : '';

            // Llenar campos ocultos para el Backend (¡IMPORTANTE!)
            document.getElementById('hidden_nombre').value = select.value;
            document.getElementById('hidden_nit').value = nit;
            document.getElementById('hidden_email').value = email;
        }

        // 2. CAMBIO DE RÉGIMEN (IVA / NO IVA)
        function setRegimen(tipo) {
            regimen = tipo;
            document.getElementById('empresa_tipo_field').value = tipo;
            
            // Estilos de botones
            const btnA = document.getElementById('btnA');
            const btnB = document.getElementById('btnB');
            
            if (tipo === 'A') {
                btnA.className = "flex-1 py-3 rounded-xl text-xs font-black transition-all bg-white text-blue-600 shadow-sm ring-2 ring-blue-100";
                btnB.className = "flex-1 py-3 rounded-xl text-xs font-black transition-all text-slate-400 hover:bg-slate-50";
                document.getElementById('logo_vista').src = "/static/{{ empresa_a.logo_img }}";
                document.getElementById('fila_iva').style.display = 'flex';
            } else {
                btnA.className = "flex-1 py-3 rounded-xl text-xs font-black transition-all text-slate-400 hover:bg-slate-50";
                btnB.className = "flex-1 py-3 rounded-xl text-xs font-black transition-all bg-green-500 text-white shadow-sm";
                document.getElementById('logo_vista').src = "/static/{{ empresa_b.logo_img }}";
                document.getElementById('fila_iva').style.display = 'none';
            }
            calcularTotales();
        }

        // 3. AGREGAR LÍNEA DE PRODUCTO (Corrección Data-Precio)
        function agregarLinea() {
            const id = itemCount++;
            
            // Construir opciones del select. IMPORTANTE: Value=Nombre, Data-Precio=Precio
            let opcionesHTML = '<option value="" data-precio="0">-- Elegir Ítem --</option>';
            catalogo.forEach(p => {
                opcionesHTML += `<option value="${p.nombre}" data-precio="${p.precio}">${p.nombre}</option>`;
            });
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-4">
                    <select onchange="actualizarFila(this, ${id})" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-xs font-bold focus:bg-white transition-colors cursor-pointer hover:bg-slate-100">
                        ${opcionesHTML}
                    </select>
                </td>
                <td class="p-4 text-right font-mono text-xs font-bold text-slate-500">
                    <input type="text" id="display_precio_${id}" class="w-full text-right bg-transparent border-none focus:ring-0" value="$ 0" readonly>
                    <input type="hidden" id="precio_real_${id}" value="0">
                </td>
                <td class="p-4">
                    <input type="number" value="1" min="1" oninput="calcularTotales()" class="w-16 mx-auto block p-2 bg-white border border-slate-200 rounded-lg text-center font-black text-xs focus:border-blue-500 outline-none">
                </td>
                <td class="p-4 text-right font-black text-xs font-mono text-slate-700" id="subtotal_fila_${id}">$ 0</td>
                <td class="p-4 text-center">
                    <button type="button" onclick="eliminarFila(this)" class="text-slate-300 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            document.getElementById('cuerpo_tabla').appendChild(tr);
        }

        // 4. ACTUALIZAR PRECIO AL SELECCIONAR PRODUCTO
        function actualizarFila(selectElement, id) {
            // Obtener precio del atributo data-precio
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const precio = parseFloat(selectedOption.getAttribute('data-precio')) || 0;
            
            // Guardar en input oculto para cálculos
            document.getElementById(`precio_real_${id}`).value = precio;
            
            // Mostrar bonito
            document.getElementById(`display_precio_${id}`).value = formatter.format(precio);
            
            calcularTotales();
        }

        // 5. ELIMINAR FILA
        function eliminarFila(btn) {
            btn.closest('tr').remove();
            calcularTotales();
        }

        // 6. CÁLCULO MAESTRO DE TOTALES
        function calcularTotales() {
            let subtotalGeneral = 0;
            
            // Recorrer todas las filas
            const filas = document.querySelectorAll('#cuerpo_tabla tr');
            
            filas.forEach(fila => {
                // Buscar inputs dentro de la fila
                const inputPrecio = fila.querySelector('input[id^="precio_real_"]');
                const inputCant = fila.querySelector('input[type="number"]');
                const spanSubtotal = fila.querySelector('[id^="subtotal_fila_"]');
                
                if (inputPrecio && inputCant) {
                    const precio = parseFloat(inputPrecio.value) || 0;
                    const cantidad = parseFloat(inputCant.value) || 0;
                    const totalLinea = precio * cantidad;
                    
                    // Actualizar subtotal de esa fila visualmente
                    spanSubtotal.innerText = formatter.format(totalLinea);
                    
                    // Sumar al general
                    subtotalGeneral += totalLinea;
                }
            });

            // Cálculos finales
            const iva = regimen === 'A' ? subtotalGeneral * 0.19 : 0;
            const totalFinal = subtotalGeneral + iva;

            // Actualizar interfaz inferior
            document.getElementById('txt_subtotal').innerText = formatter.format(subtotalGeneral);
            document.getElementById('txt_iva').innerText = formatter.format(iva);
            document.getElementById('txt_total').innerText = formatter.format(totalFinal);
        }

        // 7. EMPAQUETAR DATOS PARA ENVIAR (JSON)
        function prepararEnvio(e) {
            const filas = document.querySelectorAll('#cuerpo_tabla tr');
            let items = [];
            let valid = true;

            // Validar Cliente
            if(!document.getElementById('cliente_selector').value) {
                Swal.fire('¡Falta el Cliente!', 'Por favor selecciona un cliente antes de guardar.', 'warning');
                e.preventDefault();
                return false;
            }

            // Validar Items
            if(filas.length === 0) {
                Swal.fire('Cotización Vacía', 'Agrega al menos un producto.', 'warning');
                e.preventDefault();
                return false;
            }

            filas.forEach(fila => {
                const select = fila.querySelector('select');
                const inputPrecio = fila.querySelector('input[id^="precio_real_"]');
                const inputCant = fila.querySelector('input[type="number"]');
                
                // Si la fila tiene datos válidos, guardar
                if (select.value && inputPrecio) {
                    const precio = parseFloat(inputPrecio.value);
                    const cantidad = parseFloat(inputCant.value);
                    
                    items.push({
                        producto: select.value, // Nombre del producto
                        precio: precio,
                        cantidad: cantidad,
                        subtotal: precio * cantidad
                    });
                }
            });

            // Poner JSON en el input oculto
            document.getElementById('items_json_field').value = JSON.stringify(items);
            
            // Dejar que el form se envíe
            return true;
        }

        // Iniciar con una línea vacía
        agregarLinea();
        
        // Iniciar visualmente con el tipo A
        setRegimen('A');
    </script>
</body>
</html>